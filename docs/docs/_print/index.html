<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.76.5" /><link rel="canonical" type="text/html" href="https://lack-io.github.io/vine/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://lack-io.github.io/vine/docs/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/vine/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/vine/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/vine/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/vine/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/vine/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/vine/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/vine/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/vine/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/vine/favicons/android-192x192.png" sizes="192x192">

<title>欢迎来到 Vine 文档 | Vine</title><meta property="og:title" content="欢迎来到 Vine 文档" />
<meta property="og:description" content="Vine 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://lack-io.github.io/vine/docs/" />
<meta property="og:updated_time" content="2020-12-29T14:33:10+08:00" /><meta property="og:site_name" content="Vine" />
<meta itemprop="name" content="欢迎来到 Vine 文档">
<meta itemprop="description" content="Vine 文档">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="欢迎来到 Vine 文档"/>
<meta name="twitter:description" content="Vine 文档"/>





<link rel="preload" href="/vine/scss/main.min.9156453689c2a62860578c0dd5be0d8047f7ff28c3529bf4b8b3279efe82e52a.css" as="style">
<link href="/vine/scss/main.min.9156453689c2a62860578c0dd5be0d8047f7ff28c3529bf4b8b3279efe82e52a.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/vine/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zM197.0804 232.033c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zM197.0804 177.6188c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zM197.5309 286.4723c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zM197.0804 340.5784c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Vine</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/vine/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/lack-io/vine-example" target="_blank" ><span>实例</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/lack-io/vine" target="_blank" ><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label="站内搜索…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/vine/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">欢迎来到 Vine 文档</h1>






<div class="content">
      <p><a href="https://opensource.org/licenses/Apache-2.0"><img src="https://img.shields.io/:license-apache-blue.svg" alt="License"></a> <a href="https://pkg.go.dev/github.com/lack/vine?tab=doc"><img src="https://img.shields.io/badge/go.dev-reference-007d9c?logo=go&amp;logoColor=white&amp;style=flat-square" alt="Go.Dev reference"></a> <a href="https://travis-ci.org/lack-io/vine"><img src="https://api.travis-ci.org/lack-io/vine.svg?branch=master" alt="Travis CI"></a> <a href="https://goreportcard.com/report/github.com/lack-io/vine"><img src="https://goreportcard.com/badge/lack-io/vine" alt="Go Report Card"></a></p>
<p>Vine (<em>/vaɪn/</em>) 一套简单、高效、可插拔的分布式 RPC 框架。</p>
<h2 id="简介">简介</h2>
<p><strong>Vine</strong> 基于 <a href="https://github.com/asim/go-micro">go-micro</a> 框架，因此继承了它的优点。并在此基础上增加性能和可用性。</p>
<h2 id="主要功能">主要功能</h2>
<p><strong>Vine</strong> 抽象化分布式系统的内部细节. 以下是主要功能.</p>
<ul>
<li>
<p><strong>身份验证 (Authentication)</strong> - 身份验证和授权作为一等公民而存在。身份验证和授权通过为每个服务提供一个身份和证书来确保内部服务安全。其中海包括基于规则的访问控制。</p>
</li>
<li>
<p><strong>动态配置 (Dynamic Config)</strong> - 从任意地方加载和热加载动态配置。配置接口提供了一种方法，可以从任何源（如环境变量，文件，etcd）加载应用级别配置。同时支持合并源、甚至定义回退。</p>
</li>
<li>
<p><strong>数据存储 (Data Storage)</strong> - 一个简单的数据存储接口，用于查询，创建，删除数据记录。内置 memory，file，postgresSQL 等</p>
</li>
<li>
<p><strong>服务发现 (Service disconvery)</strong> - 自动服务注册和名称解析。服务发现是微服务开发的核心功能。当服务A与服务B通讯时，需要知道服务B的IP地址等信息。<strong>Vine</strong> 内置(mdns)作为服务发现组件，它是零配置系统。</p>
</li>
<li>
<p><strong>负载均衡 (Load Balancing)</strong> - 基于服务发现的客户端负载均衡。当内部存在多个服务实例的地址时，我们需要一种方式确定路由到哪个节点，默认使用随机指定其中一个地址。同时在请求错误时重试不同的节点。</p>
</li>
<li>
<p><strong>消息编码 (Message Encoding)</strong> - 基于<code>Content-Type</code>的动态消息编码。Codec 为客户端和服务端提供 Go 类型的编码和解码，支持各种不同的类型。默认使用 protobuf 和 json。</p>
</li>
<li>
<p><strong>gRPC 传输 (gRPC transport)</strong> - 基于 gRPC 的请求响应，同时支持双向流。<strong>Vine</strong> 为同步通讯提供一个抽象，使发向服务的请求被自动解析、负载均衡、拨号和流化。</p>
</li>
<li>
<p><strong>异步消息 (Async Messaging)</strong> - 内置订阅发布模型，作为异步通讯和事件驱动架构。事件通知属于微服务开发中的核心模式。默认的消息系统为 HTTP 事件代理。</p>
</li>
<li>
<p><strong>同步 (Synchronization)</strong> - 分布式系统通常以最终一致性的方式构建。内置的 <strong>Sync</strong> 接口实现分布式锁和领导选举。</p>
</li>
<li>
<p><strong>可插拔接口 (Pluggable Interfaces)</strong> - 得益于 Go 语言的抽象特性。 <strong>Vine</strong> 为每个模块提供抽象接口，正因为如此，这些接口都是可插拔的。可以在 <a href="https://github.com/lack-io/plugins">github.com/lack-io/plugins</a> 查询你需要的插件。</p>
</li>
</ul>
<h2 id="许可">许可</h2>
<p>Vine 遵守 Apache 2.0 开源许可.</p>
<h2 id="起步">起步</h2>
<h3 id="安装">安装</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/gogo/googleapis
go get github.com/lack-io/vine/cmd/protoc-gen-gogofaster
go get github.com/lack-io/vine/cmd/protoc-gen-vine
go get github.com/lack-io/vine
</code></pre></div><h3 id="proto-文件">proto 文件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#ff79c6">package</span> testdata;

<span style="color:#ff79c6">import</span> <span style="color:#f1fa8c">&#34;github.com/gogo/googleapis/google/api/annotations.proto&#34;</span>;

<span style="color:#8be9fd;font-style:italic">service</span> Rpc {
  <span style="color:#ff79c6">rpc</span> HelloWorld(HelloWorldRequest) <span style="color:#ff79c6">returns</span> (HelloWorldResponse) {
    <span style="color:#ff79c6">option</span> (google.api.http) <span style="color:#ff79c6">=</span> { post<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;/api/{name}&#34;</span>; body<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;*&#34;</span>; };
  };
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldRequest</span> {
  <span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">HelloWorldResponse</span> {
  <span style="color:#8be9fd">string</span> reply <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}
</code></pre></div><p>生成 golang 代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span>. <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>  -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>  -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/protobuf/protobuf <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>  -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/googleapis <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>  --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>. example/proto/test.proto
</code></pre></div><h3 id="服务端">服务端</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
	pb <span style="color:#f1fa8c">&#34;example/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> HelloWorld <span style="color:#8be9fd;font-style:italic">struct</span> {
}

<span style="color:#8be9fd;font-style:italic">func</span> (t <span style="color:#ff79c6">*</span>HelloWorld) <span style="color:#50fa7b">HelloWorld</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.HelloWorldRequest, rsp <span style="color:#ff79c6">*</span>pb.HelloWorldResponse) <span style="color:#8be9fd">error</span> {
	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;get echo request&#34;</span>)
	rsp.Reply = <span style="color:#f1fa8c">&#34;hello &#34;</span> <span style="color:#ff79c6">+</span> req.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;tt&#34;</span>),
		vine.<span style="color:#50fa7b">Address</span>(<span style="color:#f1fa8c">&#34;127.0.0.1:9000&#34;</span>),
	)

	service.<span style="color:#50fa7b">Init</span>()

	pb.<span style="color:#50fa7b">RegisterRpcHandler</span>(service.<span style="color:#50fa7b">Server</span>(), <span style="color:#8be9fd;font-style:italic">new</span>(HelloWorld))

	service.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h3 id="客户端">客户端</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
	pb <span style="color:#f1fa8c">&#34;example/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	srv <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;tt&#34;</span>))
	service <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewRpcService</span>(<span style="color:#f1fa8c">&#34;tt&#34;</span>, srv.<span style="color:#50fa7b">Client</span>())

	rsp, err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">HelloWorld</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.HelloWorldRequest{Name: <span style="color:#f1fa8c">&#34;world&#34;</span>})
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		fmt.<span style="color:#50fa7b">Println</span>(err)
		<span style="color:#ff79c6">return</span>
	}
	fmt.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;result: %v\n&#34;</span>, rsp)
}

</code></pre></div><h3 id="启动-api">启动 api</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vine api --handler<span style="color:#ff79c6">=</span>rpc
</code></pre></div><h3 id="验证">验证</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -H <span style="color:#f1fa8c">&#39;Content-Type: application/json&#39;</span> -d <span style="color:#f1fa8c">&#39;{}&#39;</span> http://localhost:8080/api/vine
</code></pre></div>
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d2c6535126cca927d2a9c893abde92a0">1 - 开始</h1>
    <div class="lead">我们将在这里学会如何创建 Service 和 Function 类型的服务。</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-fff5b0411259defe72e1f7b38ebfc59c">1.1 - Service</h1>
    <div class="lead">这是一份编写服务的更加详细的指南。<strong>Service</strong> 是其他主要组件服务的顶层接口，它将所有底层包包裹在一个更加方便的接口中。</div>
	<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Service <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// 服务名称
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Name</span>() <span style="color:#8be9fd">string</span>
	<span style="color:#6272a4">// 初始化选项
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option)
	<span style="color:#6272a4">// 返回当前选项
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#6272a4">// 返回服务的 Client 接口
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Client</span>() client.Client
	<span style="color:#6272a4">// 返回服务的 Server 接口
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Server</span>() server.Server
	<span style="color:#6272a4">// 启动服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Run</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 实现 server.Server 接口
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><h2 id="1初始化">1.初始化</h2>
<p>使用 <code>service.NewService</code> 创建服务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>

service = vine.<span style="color:#50fa7b">NewService</span>()
</code></pre></div><p>创建时使用选项</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service = vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
    vine.<span style="color:#50fa7b">Version</span>(<span style="color:#f1fa8c">&#34;latest&#34;</span>),
)
</code></pre></div><p>支持的选项，请看<a href="https://pkg.go.dev/github.com/lack-io/vine/service#Option">这里</a></p>
<p><strong>Vine</strong> 同时支持使用<code>service.Flags</code> 来提供命令行参数:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/lack-io/cli&#34;</span>
	vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
)

	service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
		vine.<span style="color:#50fa7b">Flags</span>(<span style="color:#ff79c6">&amp;</span>cli.StringFlag{
			Name:  <span style="color:#f1fa8c">&#34;environment&#34;</span>,
			Usage: <span style="color:#f1fa8c">&#34;The environment&#34;</span>,
		}),
	)
</code></pre></div><p>使用 <code>service.Init</code> 解析参数，并且使用 <code>service.Action</code> 选项来访问参数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	service.<span style="color:#50fa7b">Init</span>(
		vine.<span style="color:#50fa7b">Action</span>(<span style="color:#8be9fd;font-style:italic">func</span>(c <span style="color:#ff79c6">*</span>cli.Context) <span style="color:#8be9fd">error</span> {
			env <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;environment&#34;</span>)
			<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(env) &gt; <span style="color:#bd93f9">0</span> {
				fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Environment set to&#34;</span>, env)
			}

			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		}),
	)
</code></pre></div><p><code>service.Init</code> 支持的选择看<a href="https://pkg.go.dev/github.com/lack-io/vine/service/config/cmd#pkg-variables">这里</a></p>
<h2 id="2定义-api">2.定义 API</h2>
<p>使用 protobuf 文件定义服务的 API 接口。它可以能便利的提供严谨的 API 接口，同时为服务端和客户端提供具体的接口。
greeter.proto</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#8be9fd;font-style:italic">service</span> Greeter {
	<span style="color:#ff79c6">rpc</span> Hello(Request) <span style="color:#ff79c6">returns</span> (Response) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
	<span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Response</span> {
	<span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p>这里我们定义一个 Greeter 服务，提供 Hello 方法。Request 和 Response 是 Hello 方法的入参和返回值。</p>
<h2 id="3生成-api-接口">3.生成 API 接口</h2>
<p>你需要以下的工具来生成 protobuf 代码</p>
<ul>
<li><a href="https://github.com/protocolbuffers/protobuf">protoc</a></li>
<li><a href="https://github.com/lack-io/vine/tree/master/cmd/protoc-gen-gogofaster">protoc-gen-gogofaster</a></li>
<li><a href="https://github.com/lack-io/vine/tree/master/cmd/protoc-gen-vine">protoc-gen-vine</a></li>
</ul>
<p>使用 protoc、protoc-gen-gogofaster、protoc-gen-vine 来生成 protobuf code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/gogo/googleapis
go get github.com/lack-io/vine/cmd/protoc-gen-gogofaster
go get github.com/lack-io/vine/cmd/protoc-gen-vine
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/protobuf/protobuf --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>. greeter.proto
</code></pre></div><p>它会生成以下代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Request <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`protobuf:&#34;bytes,1,opt,name=name&#34; json:&#34;name,omitempty&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Response <span style="color:#8be9fd;font-style:italic">struct</span> {
	Greeting <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`protobuf:&#34;bytes,2,opt,name=greeting&#34; json:&#34;greeting,omitempty&#34;`</span>
}

<span style="color:#6272a4">// Client API for Greeter service
</span><span style="color:#6272a4"></span>
<span style="color:#8be9fd;font-style:italic">type</span> GreeterClient <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Hello</span>(ctx context.Context, in <span style="color:#ff79c6">*</span>Request, opts <span style="color:#ff79c6">...</span>client.CallOption) (<span style="color:#ff79c6">*</span>Response, <span style="color:#8be9fd">error</span>)
}

<span style="color:#8be9fd;font-style:italic">type</span> greeterClient <span style="color:#8be9fd;font-style:italic">struct</span> {
	c           client.Client
	serviceName <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewGreeterClient</span>(serviceName <span style="color:#8be9fd">string</span>, c client.Client) GreeterClient {
	<span style="color:#ff79c6">if</span> c <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		c = client.<span style="color:#50fa7b">NewClient</span>()
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(serviceName) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		serviceName = <span style="color:#f1fa8c">&#34;greeter&#34;</span>
	}
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>greeterClient{
		c:           c,
		serviceName: serviceName,
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>greeterClient) <span style="color:#50fa7b">Hello</span>(ctx context.Context, in <span style="color:#ff79c6">*</span>Request, opts <span style="color:#ff79c6">...</span>client.CallOption) (<span style="color:#ff79c6">*</span>Response, <span style="color:#8be9fd">error</span>) {
	req <span style="color:#ff79c6">:=</span> c.c.<span style="color:#50fa7b">NewRequest</span>(c.serviceName, <span style="color:#f1fa8c">&#34;Greeter.Hello&#34;</span>, in)
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Response)
	err <span style="color:#ff79c6">:=</span> c.c.<span style="color:#50fa7b">Call</span>(ctx, req, out, opts<span style="color:#ff79c6">...</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
	}
	<span style="color:#ff79c6">return</span> out, <span style="color:#ff79c6">nil</span>
}

<span style="color:#6272a4">// Server API for Greeter service
</span><span style="color:#6272a4"></span>
<span style="color:#8be9fd;font-style:italic">type</span> GreeterHandler <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Hello</span>(context.Context, <span style="color:#ff79c6">*</span>Request, <span style="color:#ff79c6">*</span>Response) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">RegisterGreeterHandler</span>(s server.Server, hdlr GreeterHandler) {
	s.<span style="color:#50fa7b">Handle</span>(s.<span style="color:#50fa7b">NewHandler</span>(<span style="color:#ff79c6">&amp;</span>Greeter{hdlr}))
}
</code></pre></div><h2 id="4实现-handler">4.实现 handler</h2>
<p>handler.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> proto <span style="color:#f1fa8c">&#34;github.com/vine/examples/service/proto&#34;</span>

<span style="color:#8be9fd;font-style:italic">type</span> Greeter <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>Greeter) <span style="color:#50fa7b">Hello</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.Request, rsp <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	rsp.Greeting = <span style="color:#f1fa8c">&#34;Hello &#34;</span> <span style="color:#ff79c6">+</span> req.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</code></pre></div><p>这个 handler 将被注册为服务，就像 http.Handler.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service = vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
)

pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(service.Server, <span style="color:#8be9fd;font-style:italic">new</span>(Greeter))
</code></pre></div><h2 id="5启动服务">5.启动服务</h2>
<p>服务通过调用 <code>service.Run</code> 来启动。它会绑定到配置参数提供的地址上并且监听请求。
服务启动时会通过 registry 组件注册服务，在接收到 kill 信号时注销服务。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    log.<span style="color:#50fa7b">Fatal</span>(err)
}
</code></pre></div><h2 id="6完整的服务端代码">6.完整的服务端代码</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
        <span style="color:#f1fa8c">&#34;log&#34;</span>
        <span style="color:#f1fa8c">&#34;context&#34;</span>

        vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
        pb <span style="color:#f1fa8c">&#34;github.com/lack-io/examples/service/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> Greeter <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>Greeter) <span style="color:#50fa7b">Hello</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.Request, rsp <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
        rsp.Greeting = <span style="color:#f1fa8c">&#34;Hello &#34;</span> <span style="color:#ff79c6">+</span> req.Name
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
        service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
                vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
        )

        service.<span style="color:#50fa7b">Init</span>()

        pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(service.<span style="color:#50fa7b">Server</span>(), <span style="color:#8be9fd;font-style:italic">new</span>(Greeter))

        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
                log.<span style="color:#50fa7b">Fatal</span>(err)
        }
}
</code></pre></div><h2 id="客户端">客户端</h2>
<p>查询上面的服务，可以使用以下的代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 创建 greeter 服务的客户端
</span><span style="color:#6272a4"></span>greeter <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>, service.<span style="color:#50fa7b">Client</span>())

<span style="color:#6272a4">// 请求 Greeter 的 Hello 方法
</span><span style="color:#6272a4"></span>rsp, err <span style="color:#ff79c6">:=</span> greeter.<span style="color:#50fa7b">Hello</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{
	Name: <span style="color:#f1fa8c">&#34;John&#34;</span>,
})
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
	fmt.<span style="color:#50fa7b">Println</span>(err)
	<span style="color:#ff79c6">return</span>
}

fmt.<span style="color:#50fa7b">Println</span>(rsp.Greeting)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2a676469564fbc6e83ea511cb7270fb0">1.2 - Function</h1>
    <div class="lead">这是一份关于如何编写 Function 服务的指南。Function 是指只执行一次的服务。</div>
	<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// Function 一次性执行服务
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">type</span> Function <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#6272a4">// 内置服务接口
</span><span style="color:#6272a4"></span>	Service
	<span style="color:#6272a4">// 接口服务
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Done</span>() <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 处理 rpc 请求
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Handle</span>(v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
	<span style="color:#6272a4">// 订阅者
</span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">Subscribe</span>(topic <span style="color:#8be9fd">string</span>, v <span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
}
</code></pre></div><h2 id="1初始化">1.初始化</h2>
<p>使用 <code>service.NewFunction</code> 创建 Function</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>

function = vine.<span style="color:#50fa7b">NewFunction</span>()
</code></pre></div><p>创建时使用选项</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">function = vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
    vine.<span style="color:#50fa7b">Version</span>(<span style="color:#f1fa8c">&#34;latest&#34;</span>),
)
</code></pre></div><p>支持的选项，请看<a href="https://pkg.go.dev/github.com/lack-io/vine/service#Option">这里</a></p>
<p><strong>Vine</strong> 同时支持使用<code>service.Flags</code> 来提供命令行参数:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;fmt&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/lack-io/cli&#34;</span>
	vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
)

	function <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewFunction</span>(
		vine.<span style="color:#50fa7b">Flags</span>(<span style="color:#ff79c6">&amp;</span>cli.StringFlag{
			Name:  <span style="color:#f1fa8c">&#34;environment&#34;</span>,
			Usage: <span style="color:#f1fa8c">&#34;The environment&#34;</span>,
		}),
	)
</code></pre></div><p>使用 <code>service.Init</code> 解析参数，并且使用 <code>service.Action</code> 选项来访问参数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	function.<span style="color:#50fa7b">Init</span>(
		vine.<span style="color:#50fa7b">Action</span>(<span style="color:#8be9fd;font-style:italic">func</span>(c <span style="color:#ff79c6">*</span>cli.Context) <span style="color:#8be9fd">error</span> {
			env <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;environment&#34;</span>)
			<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(env) &gt; <span style="color:#bd93f9">0</span> {
				fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Environment set to&#34;</span>, env)
			}

			<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
		}),
	)
</code></pre></div><p><code>service.Init</code> 支持的选择看<a href="https://pkg.go.dev/github.com/lack-io/vine/service/config/cmd#pkg-variables">这里</a></p>
<h2 id="2定义-api">2.定义 API</h2>
<p>使用 protobuf 文件定义服务的 API 接口。它可以能便利的提供严谨的 API 接口，同时为服务端和客户端提供具体的接口。
greeter.proto</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;proto3&#34;</span>;

<span style="color:#8be9fd;font-style:italic">service</span> Greeter {
	<span style="color:#ff79c6">rpc</span> Hello(Request) <span style="color:#ff79c6">returns</span> (Response) {}
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Request</span> {
	<span style="color:#8be9fd">string</span> name <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
}

<span style="color:#8be9fd;font-style:italic">message</span> <span style="color:#50fa7b">Response</span> {
	<span style="color:#8be9fd">string</span> greeting <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
}
</code></pre></div><p>这里我们定义一个 Greeter 服务，提供 Hello 方法。Request 和 Response 是 Hello 方法的入参和返回值。</p>
<h2 id="3生成-api-接口">3.生成 API 接口</h2>
<p>使用 protoc、protoc-gen-gogofaster、protoc-gen-vine 来生成 protobuf code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/gogo/protobuf
go get github.com/gogo/googleapis
go get github.com/lack-io/vine/cmd/protoc-gen-gogofaster
go get github.com/lack-io/vine/cmd/protoc-gen-vine
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">protoc -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src -I<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$GOPATH</span>/src/github.com/gogo/protobuf/protobuf --gogofaster_out<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">plugins</span><span style="color:#ff79c6">=</span>grpc:. --vine_out<span style="color:#ff79c6">=</span>. greeter.proto
</code></pre></div><p>它会生成以下代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Request <span style="color:#8be9fd;font-style:italic">struct</span> {
	Name <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`protobuf:&#34;bytes,1,opt,name=name&#34; json:&#34;name,omitempty&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">type</span> Response <span style="color:#8be9fd;font-style:italic">struct</span> {
	Greeting <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`protobuf:&#34;bytes,2,opt,name=greeting&#34; json:&#34;greeting,omitempty&#34;`</span>
}

<span style="color:#6272a4">// Client API for Greeter service
</span><span style="color:#6272a4"></span>
<span style="color:#8be9fd;font-style:italic">type</span> GreeterClient <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Hello</span>(ctx context.Context, in <span style="color:#ff79c6">*</span>Request, opts <span style="color:#ff79c6">...</span>client.CallOption) (<span style="color:#ff79c6">*</span>Response, <span style="color:#8be9fd">error</span>)
}

<span style="color:#8be9fd;font-style:italic">type</span> greeterClient <span style="color:#8be9fd;font-style:italic">struct</span> {
	c           client.Client
	serviceName <span style="color:#8be9fd">string</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewGreeterClient</span>(serviceName <span style="color:#8be9fd">string</span>, c client.Client) GreeterClient {
	<span style="color:#ff79c6">if</span> c <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
		c = client.<span style="color:#50fa7b">NewClient</span>()
	}
	<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(serviceName) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> {
		serviceName = <span style="color:#f1fa8c">&#34;greeter&#34;</span>
	}
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>greeterClient{
		c:           c,
		serviceName: serviceName,
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>greeterClient) <span style="color:#50fa7b">Hello</span>(ctx context.Context, in <span style="color:#ff79c6">*</span>Request, opts <span style="color:#ff79c6">...</span>client.CallOption) (<span style="color:#ff79c6">*</span>Response, <span style="color:#8be9fd">error</span>) {
	req <span style="color:#ff79c6">:=</span> c.c.<span style="color:#50fa7b">NewRequest</span>(c.serviceName, <span style="color:#f1fa8c">&#34;Greeter.Hello&#34;</span>, in)
	out <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">new</span>(Response)
	err <span style="color:#ff79c6">:=</span> c.c.<span style="color:#50fa7b">Call</span>(ctx, req, out, opts<span style="color:#ff79c6">...</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
	}
	<span style="color:#ff79c6">return</span> out, <span style="color:#ff79c6">nil</span>
}

<span style="color:#6272a4">// Server API for Greeter service
</span><span style="color:#6272a4"></span>
<span style="color:#8be9fd;font-style:italic">type</span> GreeterHandler <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Hello</span>(context.Context, <span style="color:#ff79c6">*</span>Request, <span style="color:#ff79c6">*</span>Response) <span style="color:#8be9fd">error</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">RegisterGreeterHandler</span>(s server.Server, hdlr GreeterHandler) {
	s.<span style="color:#50fa7b">Handle</span>(s.<span style="color:#50fa7b">NewHandler</span>(<span style="color:#ff79c6">&amp;</span>Greeter{hdlr}))
}
</code></pre></div><h2 id="4实现-handler">4.实现 handler</h2>
<p>handler.go</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">import</span> proto <span style="color:#f1fa8c">&#34;github.com/vine/examples/service/proto&#34;</span>

<span style="color:#8be9fd;font-style:italic">type</span> Greeter <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>Greeter) <span style="color:#50fa7b">Hello</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.Request, rsp <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
	rsp.Greeting = <span style="color:#f1fa8c">&#34;Hello &#34;</span> <span style="color:#ff79c6">+</span> req.Name
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}
</code></pre></div><p>这个 handler 将被注册为服务，就像 http.Handler.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">function = vine.<span style="color:#50fa7b">NewFunction</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
)

pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(function.Server, <span style="color:#8be9fd;font-style:italic">new</span>(Greeter))
</code></pre></div><h2 id="5启动-function">5.启动 Function</h2>
<p>服务通过调用 <code>function.Run</code> 来启动。它会绑定到配置参数提供的地址上并且监听请求。
服务启动时会通过 registry 组件注册服务，在接收到 kill 信号时注销服务。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> function.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    log.<span style="color:#50fa7b">Fatal</span>(err)
}
</code></pre></div><h2 id="6完整的服务端代码">6.完整的服务端代码</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
        <span style="color:#f1fa8c">&#34;log&#34;</span>
        <span style="color:#f1fa8c">&#34;context&#34;</span>

        vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>
        pb <span style="color:#f1fa8c">&#34;github.com/lack-io/examples/service/proto&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">type</span> Greeter <span style="color:#8be9fd;font-style:italic">struct</span>{}

<span style="color:#8be9fd;font-style:italic">func</span> (g <span style="color:#ff79c6">*</span>Greeter) <span style="color:#50fa7b">Hello</span>(ctx context.Context, req <span style="color:#ff79c6">*</span>pb.Request, rsp <span style="color:#ff79c6">*</span>pb.Response) <span style="color:#8be9fd">error</span> {
        rsp.Greeting = <span style="color:#f1fa8c">&#34;Hello &#34;</span> <span style="color:#ff79c6">+</span> req.Name
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
        function <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewFunction</span>(
                vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
        )

        function.<span style="color:#50fa7b">Init</span>()

        pb.<span style="color:#50fa7b">RegisterGreeterHandler</span>(function.<span style="color:#50fa7b">Server</span>(), <span style="color:#8be9fd;font-style:italic">new</span>(Greeter))

        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> function.<span style="color:#50fa7b">Run</span>(); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
                log.<span style="color:#50fa7b">Fatal</span>(err)
        }
}
</code></pre></div><h2 id="客户端">客户端</h2>
<p>查询上面的 Function，可以使用以下的代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 创建 greeter 服务的客户端
</span><span style="color:#6272a4"></span>greeter <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>, function.<span style="color:#50fa7b">Client</span>())

<span style="color:#6272a4">// 请求 Greeter 的 Hello 方法
</span><span style="color:#6272a4"></span>rsp, err <span style="color:#ff79c6">:=</span> greeter.<span style="color:#50fa7b">Hello</span>(context.<span style="color:#50fa7b">TODO</span>(), <span style="color:#ff79c6">&amp;</span>pb.Request{
	Name: <span style="color:#f1fa8c">&#34;John&#34;</span>,
})
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
	fmt.<span style="color:#50fa7b">Println</span>(err)
	<span style="color:#ff79c6">return</span>
}

fmt.<span style="color:#50fa7b">Println</span>(rsp.Greeting)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aec8fd34bb59ef246e6dc4615487b686">2 - 平台</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4b0c32bc235e57563240178a3acc8929">2.1 - 命令行工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c1f703cea8acc52eb3783cf4153c4f11">3 - 框架</h1>
    <div class="lead">我们将深入了解 Vine 框架的内部原理。</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b582ac791ee9a29a931c2b773f0e7987">3.1 - 接口</h1>
    <div class="lead">Vine 是一个可插拔的框架，它利用接口进行抽象和构建基础模块。这使我们能够为分布式系统的概念建立强定义的抽象和可替换的实现。</div>
	<p><img src="2020-12-29-08-51-23.png" alt="service内部结构"></p>
<h2 id="接口">接口</h2>
<p><strong>Vine</strong> 内置以下的接口列表</p>
<ul>
<li><strong>Auth</strong> - 身份验证和授权</li>
<li><strong>broker</strong> - 异步消息</li>
<li><strong>client</strong> - 高级请求/响应和消息通知</li>
<li><strong>config</strong> - 动态配置</li>
<li><strong>codec</strong> - 消息编码和解码</li>
<li><strong>debug</strong> - debug 日志，跟踪，统计信息</li>
<li><strong>network</strong> - 多云下的网络</li>
<li><strong>registry</strong> - 服务发现</li>
<li><strong>runtime</strong> - 服务运行时状态</li>
<li><strong>selector</strong> - 均衡负载</li>
<li><strong>server</strong> - 处理请求和通知</li>
<li><strong>store</strong> - 数据存储</li>
<li><strong>sync</strong> - 同步，锁和领导选举</li>
<li><strong>transport</strong> - 同步通讯</li>
<li><strong>tunnel</strong> - vpn 隧道</li>
</ul>
<h2 id="broker">Broker</h2>
<p><strong>Broker</strong> 为异步 pub/sub 子通讯提供消息代理的接口。这是事件驱动结构和微服务的基本要求之一。在默认情况下，我们使用 HTTP 协议实现 Broker 接口，以减少依赖。在 <a href="github.com/lack-io/plugins">plugins</a> 中有许多 Broker 的实现。例如：RabbitMQ，NATS，NSQ等。</p>
<h2 id="client">Client</h2>
<p><strong>Client</strong> 提供一个接口来向服务发出请求。和 Server 一样，它构建在其他包上并提供统一的接口。使用 Registry 来查找服务，使用Transport进行同步请求。</p>
<h2 id="codec">Codec</h2>
<p><strong>Codec</strong> 用于编码和解码消息。这些数据格式可能是 json, protobuf, beson 等。同时还是各种 RPC 数据格式，例如 PROTO-RPC, JSON-RPC, BSON-RPC等。它将编码解码与 Client/Server 分离，并提供继承其他系统的强大方法。</p>
<h2 id="config">Config</h2>
<p><strong>Config</strong> 是一个接口。用于从任意数量的源进行动态配置加载，这些源可以合并。大多数系统都主动要求有独立于代码进行更改的配置。通过<strong>Config</strong>接口，可以根据需要动态加载这些值，它还支持各种不同的配置格式。</p>
<h2 id="server">Server</h2>
<p><strong>Server</strong> 是编写服务器基础模块。在这里，你可以为服务命名，注册请求处理器，添加中间件等。该服务基于上述包，为服务请求提供统一接口。目前有 gRPC 和 HTTP 两种内置实现。<strong>Server</strong> 还允许你定义多个 Codec 以服务不同的编码消息。</p>
<h2 id="store">Store</h2>
<p><strong>Store</strong> 是一个简单的键值对存储接口，用于抽象轻量级的数据存储。我们不是在试图实现一个完整的 sql 语言或者存储，只是仅仅保存服务状态。</p>
<h2 id="registry">Registry</h2>
<p><strong>Registry</strong> 提供一种服务发现机制，能将服务名称解析为对应的IP地址。它可以由 consul，etcd，zookeeper，dns等支持。服务在启动时注册到 <strong>Registry</strong> 中，并在关闭是注销。服务可能选择提供 TTL，并在这个间隔时间内重新注册，以确保服务在失效时进行清理。</p>
<h2 id="selector">Selector</h2>
<p><strong>Selector</strong> 是负载均衡的一种抽象，它建立在 <em>Registry</em> 上。它允许通过对应的策略选择服务，如随机，循环，最小等算法选择服务。<strong>Client</strong> 在请求时使用 <strong>Selector</strong> 来实现客户端均衡负载。</p>
<h2 id="transport">Transport</h2>
<p><strong>Transport</strong> 是服务之间同步请求/响应的接口。它类似与 golang 网络包，但提供一个更高级别的抽象，允许我们切换通讯机制，例如 http、rabbitmq、websocket、NATS等。它还支持双向流。</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7b352eb699fbe1bfd3f3a1a2ca1fbe0a">3.2 - 错误</h1>
    <div class="lead">Vine 为错误提供抽象和类型。通过提供一组核心错误和定义详细错误类型，我们可以始终如一地了解运行时出现的错误。</div>
	<h2 id="概述">概述</h2>
<p>我们定义以下错误类型</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Error <span style="color:#8be9fd;font-style:italic">struct</span> {
	Id       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;id,omitempty&#34;`</span>
	Code     <span style="color:#8be9fd">int32</span>  <span style="color:#f1fa8c">`json:&#34;code,omitempty&#34;`</span>
	Detail   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;detail,omitempty&#34;`</span>
	Status   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;status,omitempty&#34;`</span>
	Position <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;position,omitempty&#34;`</span>
}
</code></pre></div><p>在系统中，要求用户从处理程序返回错误或从客户端接收错误的任何位置，都应认为是 <strong>Vine</strong> 错误，或者应该生成错误。默认情况下，我们返回 <code>errors.InternalServerError</code>，如果出现错误错误则返回 <code>errors.Timeout</code>。</p>
<h2 id="使用">使用</h2>
<p>让我们假设程序中发生错误，然后，你应该确定返回哪种错误，并执行以下操作。
假设提供的数据无效：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">badRequest</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;invalid field&#34;</span>)
</code></pre></div><p>如果发生内部错误</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">InternalServerError</span>(<span style="color:#f1fa8c">&#34;com.example.srv.service&#34;</span>, <span style="color:#f1fa8c">&#34;failed to read db: %v&#34;</span>, err.<span style="color:#50fa7b">Error</span>())
}
</code></pre></div><p>如果你从客户端收到一些错误，可以按照以下方式处理:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">cc <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">NewGreeterService</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.greeter&#34;</span>, service.<span style="color:#50fa7b">Client</span>())
rsp, err <span style="color:#ff79c6">:=</span> pb.<span style="color:#50fa7b">Clinet</span>(ctx, req)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
    <span style="color:#6272a4">// parse out the error 
</span><span style="color:#6272a4"></span>    e <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Parse</span>(err.<span style="color:#50fa7b">Error</span>())

    <span style="color:#6272a4">// inspect the value
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> e.Code <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">401</span> {
        <span style="color:#6272a4">// unauthorized
</span><span style="color:#6272a4"></span>    }
}
</code></pre></div><h2 id="错误列表">错误列表</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadGateway</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BadRequest</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Conflict</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Forbidden</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GatewayTimeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InternalServerError</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">MethodNotAllowed</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotFound</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NotImplemented</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ServiceUnavailable</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Timeout</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Unauthorized</span>(id, format <span style="color:#8be9fd">string</span>, a <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">error</span>
</code></pre></div><h2 id="自定义错误">自定义错误</h2>
<p>除了内置的错误类型之外，<strong>Vine</strong> 支持自定义错误类型</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">// 自定义错误，并记录错误位置
</span><span style="color:#6272a4"></span>customErr <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;go.vine.srv.example&#34;</span>, <span style="color:#f1fa8c">&#34;custom error&#34;</span>, <span style="color:#bd93f9">510</span>, <span style="color:#ff79c6">true</span>)
</code></pre></div><h2 id="其他">其他</h2>
<p>判断错误类型是否相同</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">b <span style="color:#ff79c6">:=</span> errors.<span style="color:#50fa7b">Equal</span>(err1, err2)
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-adc9362cc6e11026e9d62feebf4929a9">3.3 - 选项</h1>
    <div class="lead"><strong>Vine</strong> 使用可变选项模型来设计包的创建和初始化传递参数，以及作为方法的可选参数。这为扩展跨插件的选项使用提供了灵活性</div>
	<h2 id="概述">概述</h2>
<p>创建新服务时，你可以选择传递其他参数，例如设置名称，版本，Broker，Registry 或者存储，以便与所有其他内部实现一起使用。
选项通常定义如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Options <span style="color:#8be9fd;font-style:italic">struct</span> {
    Name        <span style="color:#8be9fd">string</span>
    Version     <span style="color:#8be9fd">string</span>
    Broker      broker.Broker
    Registry    registry.Registry
}


<span style="color:#8be9fd;font-style:italic">type</span> Option <span style="color:#8be9fd;font-style:italic">func</span>(<span style="color:#ff79c6">*</span>Options)

<span style="color:#6272a4">// set the name
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Name</span>(n <span style="color:#8be9fd">string</span>) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Name = n
    }
}

<span style="color:#6272a4">// set the broker
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Broker</span>(b broker.Broker) Option {
    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">func</span>(o <span style="color:#ff79c6">*</span>Options) {
        o.Broker = b
    }
}
</code></pre></div><p>然后这安装如下方式设置这些选项</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
    vine.<span style="color:#50fa7b">Broker</span>(broker),
)
</code></pre></div><h2 id="服务选项">服务选项</h2>
<p>在 <strong>Vine</strong> 中，我们有许多选项可以设置，包括用于身份验证，配置和存储等内容的基础包。你可以使用 <code>service.Options()</code> 来访问这些。</p>
<p>auth、config、registry、store 等包将默认为我们的零依赖插件。可以通过设置环境变量或者命令行参数来配置它们，在执行 <code>service.Init()</code> 后生效。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4">## as an env vars</span>
<span style="color:#8be9fd;font-style:italic">VINE_STORE</span><span style="color:#ff79c6">=</span>file go run main.go

<span style="color:#6272a4">## or as a flag</span>
go run main.go --store<span style="color:#ff79c6">=</span>file
</code></pre></div><p>然后在内部，可以通过选项访问存储：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
    vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;foobar&#34;</span>),
)

service.<span style="color:#50fa7b">Init</span>()

store <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">Options</span>().Store
</code></pre></div><blockquote>
<p><strong>Vine</strong> 每个内部接口一般都有对应的选项，在插件中，额外的选项通常被保存在 <code>context.Context</code> 中。</p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-350e73aa9484175734bb9f2f75ad21ee">3.4 - 插件</h1>
    <div class="lead"><strong>Vine</strong> 是一个可插拔的框架。</div>
	<h2 id="概述">概述</h2>
<p><strong>Vine</strong> 构建在 Go 接口之上。因此这些接口的实现是可插拔的。</p>
<p>默认情况下，<strong>Vine</strong> 只提供核心上每个接口的几个实现，但它完全是可插拔的。而额外的实现保存在 <a href="https://github.com/lack-io/plugins">plugins</a>。</p>
<h2 id="添加插件">添加插件</h2>
<p>如果要集成插件，只需将它们链接到单独的文件中并重新生成。
创建 plugins.go 文件并导入所需的插件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    <span style="color:#6272a4">// consul registry
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/registry/consul&#34;</span>
    <span style="color:#6272a4">// rabbitmq transport
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/transport/rabbitmq&#34;</span>
    <span style="color:#6272a4">// kafka broker
</span><span style="color:#6272a4"></span>    _ <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/broker/kafka&#34;</span>
)
</code></pre></div><p>通过包含插件文件来构建应用程序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go build -o service main.go plugins.go
</code></pre></div><p>使用插件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">service --registry<span style="color:#ff79c6">=</span>consul --transport<span style="color:#ff79c6">=</span>nats --broker<span style="color:#ff79c6">=</span>kafka
</code></pre></div><p>或者使用环境变量</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">VINE_REGISTRY</span><span style="color:#ff79c6">=</span>consule <span style="color:#8be9fd;font-style:italic">VINE_TRANSPORT</span><span style="color:#ff79c6">=</span>rabbitmq <span style="color:#8be9fd;font-style:italic">VINE_BROKER</span><span style="color:#ff79c6">=</span>kafka service
</code></pre></div><h2 id="插件选项">插件选项</h2>
<p>或者你可以将插件设置在选项中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
    vine <span style="color:#f1fa8c">&#34;github.com/lack-io/vine/service&#34;</span>

    <span style="color:#6272a4">// consul registry
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/registry/consul&#34;</span>
    <span style="color:#6272a4">// rabbitmq transport
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/transport/rabbitmq&#34;</span>
    <span style="color:#6272a4">// kafka broker
</span><span style="color:#6272a4"></span>    <span style="color:#f1fa8c">&#34;github.com/lack-io/plugins/broker/kafka&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
    registry <span style="color:#ff79c6">:=</span> consul.<span style="color:#50fa7b">NewRegistry</span>()
    broker <span style="color:#ff79c6">:=</span> kafka.<span style="color:#50fa7b">NewBroker</span>()
    transport <span style="color:#ff79c6">:=</span> rabbitmq.<span style="color:#50fa7b">NewTransport</span>()

    service <span style="color:#ff79c6">:=</span> vine.<span style="color:#50fa7b">NewService</span>(
        vine.<span style="color:#50fa7b">Name</span>(<span style="color:#f1fa8c">&#34;greeter&#34;</span>),
        vine.<span style="color:#50fa7b">Registry</span>(registry),
        vine.<span style="color:#50fa7b">Broker</span>(broker),
        vine.<span style="color:#50fa7b">Transport</span>(transport),
    )

    service.<span style="color:#50fa7b">Init</span>()

    service.<span style="color:#50fa7b">Run</span>()
}
</code></pre></div><h2 id="编写插件">编写插件</h2>
<p>插件是一个建立在 Go 接口上的概念。每个包都维护一个高级接口抽象。只需实现接口并将其作为服务选项传递给它即可.</p>
<p>服务发现接口称为 <a href="https://pkg.go.dev/github.com/lack-io/vine/service/registry#Registry">Registry</a>. 实现此接口的任何内容都可以用作 <strong>Registry</strong>。这同样适用于其他包.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Registry <span style="color:#8be9fd;font-style:italic">interface</span> {
	<span style="color:#50fa7b">Init</span>(<span style="color:#ff79c6">...</span>Option) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Options</span>() Options
	<span style="color:#50fa7b">Register</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>RegisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">Deregister</span>(<span style="color:#ff79c6">*</span>Service, <span style="color:#ff79c6">...</span>DeregisterOption) <span style="color:#8be9fd">error</span>
	<span style="color:#50fa7b">GetService</span>(<span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span>GetOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">ListServices</span>(<span style="color:#ff79c6">...</span>ListOption) ([]<span style="color:#ff79c6">*</span>Service, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">Watch</span>(<span style="color:#ff79c6">...</span>WatchOption) (Watcher, <span style="color:#8be9fd">error</span>)
	<span style="color:#50fa7b">String</span>() <span style="color:#8be9fd">string</span>
}
</code></pre></div><p>查阅 <a href="https://github.com/lack-io/plugins">plugins</a> 可以更好地了解实现细节。</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0197e1e05d067fc3504eedd99c4d5592">3.5 - 配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-02d1b61cd0d5617eb116926601841d38">3.6 - 编码解码器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f833617c6f69348c101d928a227dd8f1">3.7 - 服务发现</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cc3c52fffa628c35132ab5716e6d881d">3.8 - API处理器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e968c411e9a826b9fc69750bc235104">3.9 - 订阅发布</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ecaf623d4e372a9eb3273aaa281180a6">3.10 - 服务端</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2c6a01c956cda1aff241446b8e8f1824">3.11 - 客户端</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3ca81f5fc04e340cf8ec3978f3fcac6a">3.12 - 身份验证</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bc9663724a347e62fe3d19c078dceda8">3.13 - 网络服务</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cfb722c14a3b2c110137b4abce5d562b">3.14 - 数据存储</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8d7a2ff4f0009b4270026942706ae2cf">3.15 - web服务</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-561b705ca852ca3645eaa6587e433036">3.16 - 请求代理</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2020 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">隐私政策</a></small>
	
		<p class="mt-2"><a href="/vine/about/">about</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.8.1/dist/mermaid.min.js" integrity="sha384-to2w0I1OqmbJ9J6yTnIX+KYU8grNpZoD1dKPLjgEJvMe5L5+/7qvuNa2sQo8WAWj" crossorigin="anonymous"></script>










<script src="/vine/js/main.min.81e9088f3e71ec0dcf796d72ffdc5103949e3aa6ba3e66cfcb74915da20475fe.js" integrity="sha256-gekIjz5x7A3PeW1y/9xRA5SeOqa6PmbPy3SRXaIEdf4=" crossorigin="anonymous"></script>




  </body>
</html>
